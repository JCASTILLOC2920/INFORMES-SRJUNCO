<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Informes de Anatomía Patológica</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-file-medical-alt"></i> Generador de Informes de Anatomía Patológica</h1>
        
        <div class="info-box">
            <p><i class="fas fa-info-circle"></i> Complete todos los campos obligatorios (*) para generar el informe.</p>
        </div>
        
        <form id="pathologyForm">
            
            <!-- Datos del paciente -->
            <div class="form-section">
                <h2><i class="fas fa-user-injured"></i> Datos del Paciente</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="code" class="required">Código</label>
                        <input type="text" id="code" name="code" placeholder="Ej: JQ25-427" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="name" class="required">Nombre y Apellidos</label>
                        <input type="text" id="name" name="name" placeholder="Ej: Anderson PAJARES Prudencio" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="age" class="required">Edad</label>
                        <input type="text" id="age" name="age" placeholder="Ej: 31 años" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="ind" class="required">IND (Médico Clínico)</label>
                        <input type="text" id="ind" name="ind" placeholder="Ej: Dr. Salemir A. LINDO G." required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="sample" class="required">Muestra</label>
                    <input type="text" id="sample" name="sample" placeholder="Ej: Quiste en glúteo derecho" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="receptionDate" class="required">Fecha de Recepción</label>
                        <input type="date" id="receptionDate" name="receptionDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportDate" class="required">Fecha de Informe</label>
                        <input type="date" id="reportDate" name="reportDate" required>
                    </div>
                </div>
            </div>
            
            <!-- Exámenes -->
            <div class="form-section">
                <h2><i class="fas fa-microscope"></i> Exámenes</h2>
                
                <div class="form-group">
                    <label for="macroscopicExam">Examen Macroscópico</label>
                    <textarea id="macroscopicExam" name="macroscopicExam" placeholder="Describa el examen macroscópico..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="microscopicExam">Examen Microscópico</label>
                    <textarea id="microscopicExam" name="microscopicExam" placeholder="Describa el examen microscópico..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="diagnosis">Diagnóstico</label>
                    <textarea id="diagnosis" name="diagnosis" placeholder="Escriba el diagnóstico..."></textarea>
                </div>
            </div>
            
            <div class="button-container">
                <button type="button" id="previewBtn"><i class="fas fa-eye"></i> Previsualizar</button>
                <button type="button" id="generateBtn"><i class="fas fa-file-word"></i> Generar Word</button>
                <button type="button" id="newDocBtn" class="btn-new"><i class="fas fa-eraser"></i> Limpiar</button>
            </div>
        </form>

        <!-- Sección de previsualización -->
        <div id="previewSection" class="preview-section hidden">
            <div class="preview-header">
                <h2><i class="fas fa-file-alt"></i> Vista Previa del Informe</h2>
                <button type="button" id="closePreview"><i class="fas fa-times"></i> Cerrar</button>
            </div>
            <div id="previewContent" class="preview-content">
                <!-- Aquí se mostrará la previsualización -->
            </div>
        </div>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Generando documento, por favor espere...</p>
        </div>

        <div id="successMessage" class="success-message">
            <i class="fas fa-check-circle"></i> Documento generado exitosamente
        </div>
    </div>

    <!-- Incluir las librerías necesarias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.1/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.1/pizzip-utils.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.42.1/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('pathologyForm');
            const previewBtn = document.getElementById('previewBtn');
            const generateBtn = document.getElementById('generateBtn');
            const closePreviewBtn = document.getElementById('closePreview');
            const previewSection = document.getElementById('previewSection');
            const previewContent = document.getElementById('previewContent');
            const loading = document.getElementById('loading');
            const successMessage = document.getElementById('successMessage');

            // Función para formatear fechas de YYYY-MM-DD a DD/MM/AAAA
            function formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }

            // Función para validar campos obligatorios
            function validateForm() {
                const requiredFields = form.querySelectorAll('[required]');
                let isValid = true;
                
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        isValid = false;
                        field.classList.add('error');
                    } else {
                        field.classList.remove('error');
                    }
                });
                
                return isValid;
            }

            // Función para obtener los datos del formulario
            function getFormData() {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                // Formatear fechas
                data.fecha_recepcion = formatDate(data.receptionDate);
                data.fecha_informe = formatDate(data.reportDate);
                
                return {
                    nombre: data.name,
                    codigo: data.code,
                    edad: data.age,
                    ind: data.ind,
                    muestra: data.sample,
                    fecha_recepcion: data.fecha_recepcion,
                    fecha_informe: data.fecha_informe,
                    examen_macroscopico: data.macroscopicExam,
                    examen_microscopico: data.microscopicExam,
                    diagnostico: data.diagnosis
                };
            }

            // Función para generar la previsualización
            function generatePreview() {
                if (!validateForm()) {
                    alert('Por favor, complete todos los campos obligatorios marcados con *.');
                    return;
                }
                
                const data = getFormData();

                // Guardar los datos en sessionStorage para que la otra página los lea
                sessionStorage.setItem('reportData', JSON.stringify(data));

                // Abrir la página de previsualización en una nueva pestaña
                window.open('preview.html', '_blank');
            }

            // Función para generar el documento Word
            function generateWord() {
                if (!validateForm()) {
                    alert('Por favor, complete todos los campos obligatorios marcados con *.');
                    return;
                }
                
                const data = getFormData();
                
                // Mostrar loading
                loading.classList.remove('hidden');
                generateBtn.disabled = true;
                
                // Crear una plantilla básica en memoria si no se puede cargar una externa
                const templateContent = `
                    <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                    <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
                        <w:body>
                            <w:p><w:r><w:t>INFORME DE ANATOMÍA PATOLÓGICA</w:t></w:r></w:p>
                            <w:p><w:r><w:t>NOMBRE: {nombre} . {codigo}</w:t></w:r></w:p>
                            <w:p><w:r><w:t>EDAD: {edad}</w:t></w:r></w:p>
                            <w:p><w:r><w:t>IND: {ind}</w:t></w:r></w:p>
                            <w:p><w:r><w:t>MUESTRA: {muestra}</w:t></w:r></w:p>
                            <w:p><w:r><w:t>FECHA RECEPCIÓN: {fecha_recepcion}   FECHA DE INFORME: {fecha_informe}</w:t></w:r></w:p>
                            <w:p><w:r><w:t></w:t></w:r></w:p>
                            {#examen_macroscopico}
                            <w:p><w:r><w:t>EXAMEN MACROSCÓPICO</w:t></w:r></w:p>
                            <w:p><w:r><w:t>{examen_macroscopico}</w:t></w:r></w:p>
                            <w:p><w:r><w:t></w:t></w:r></w:p>
                            {/examen_macroscopico}
                            {#examen_microscopico}
                            <w:p><w:r><w:t>EXAMEN MICROSCÓPICO</w:t></w:r></w:p>
                            <w:p><w:r><w:t>{examen_microscopico}</w:t></w:r></w:p>
                            <w:p><w:r><w:t></w:t></w:r></w:p>
                            {/examen_microscopico}
                            {#diagnostico}
                            <w:p><w:r><w:t>DIAGNÓSTICO</w:t></w:r></w:p>
                            <w:p><w:r><w:t>{diagnostico}</w:t></w:r></w:p>
                            {/diagnostico}
                        </w:body>
                    </w:document>
                `;
                
                try {
                    // 1. Cargar la plantilla XML en una instancia de PizZip
                    const zip = new window.PizZip(templateContent, { base64: false });
                    
                    // 2. Crear la instancia de docxtemplater con el zip y las opciones
                    const doc = new window.docxtemplater(zip, {
                        paragraphLoop: true,
                        linebreaks: true,
                        nullGetter: () => "",
                    });

                    // Renderizar el documento con los datos
                    doc.render(data);
                    
                    // Generar el documento como blob
                    const out = doc.getZip().generate({
                        type: "blob",
                        mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                    });
                    
                    // Descargar el documento
                    saveAs(out, `${data.codigo} ${data.nombre}.docx`);
                    
                    // Mostrar mensaje de éxito
                    successMessage.style.display = 'block';
                    setTimeout(() => {
                        successMessage.style.display = 'none';
                    }, 3000);
                    
                } catch (error) {
                    console.error('Error al generar el documento:', error);
                    alert('Error al generar el documento: ' + error.message);
                } finally {
                    loading.classList.add('hidden');
                    generateBtn.disabled = false;
                }
            }

            // Función para limpiar el formulario
            function clearForm() {
                form.reset();
                previewSection.classList.add('hidden');
                const requiredFields = form.querySelectorAll('[required]');
                requiredFields.forEach(field => {
                    field.classList.remove('error');
                });
                // Restablecer fechas por defecto
                setDefaultDates();
                // Enfocar el primer campo
                document.getElementById('code').focus();
            }

            // Event Listeners
            const newDocBtn = document.getElementById('newDocBtn');
            previewBtn.addEventListener('click', generatePreview);
            generateBtn.addEventListener('click', generateWord);
            closePreviewBtn.addEventListener('click', function() {
                previewSection.classList.add('hidden');
            });
            newDocBtn.addEventListener('click', clearForm);
            
            // Establecer fechas por defecto (hoy y dentro de 7 días)
            const today = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7);
            
            function setDefaultDates() {
                document.getElementById('receptionDate').valueAsDate = today;
                document.getElementById('reportDate').valueAsDate = nextWeek;
            }
            
            setDefaultDates();
            
            // Validar campos en tiempo real
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                field.addEventListener('input', function() {
                    if (this.value.trim()) {
                        this.classList.remove('error');
                    }
                });
            });
        });
    </script>
</body>
</html>
