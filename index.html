<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Informes de Anatomía Patológica</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fa;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eaeaea;
        }

        h2 {
            color: #3498db;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eaeaea;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .button-container {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #previewBtn {
            background-color: #2ecc71;
            color: white;
        }

        #generateBtn {
            background-color: #3498db;
            color: white;
        }

        #closePreview {
            background-color: #e74c3c;
            color: white;
        }

        /* Estilos para la previsualización */
        .preview-section {
            margin-top: 2rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 1rem;
            background-color: #f9f9f9;
        }
        
        .preview-content {
            background-color: white;
            padding: 1.5rem;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-family: Arial, sans-serif;
            line-height: 1.5;
            white-space: pre-line;
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            margin: 2rem 0;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .required::after {
            content: " *";
            color: #e74c3c;
        }

        .error {
            border-color: #e74c3c !important;
        }

        .success-message {
            background-color: #2ecc71;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .info-box {
            background-color: #e8f4fc;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 5px 5px 0;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .button-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-file-medical-alt"></i> Generador de Informes de Anatomía Patológica</h1>
        
        <div class="info-box">
            <p><i class="fas fa-info-circle"></i> Complete todos los campos obligatorios (*) para generar el informe.</p>
        </div>
        
        <form id="pathologyForm">
            
            <!-- Datos del paciente -->
            <div class="form-section">
                <h2><i class="fas fa-user-injured"></i> Datos del Paciente</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="code" class="required">Código</label>
                        <input type="text" id="code" name="code" placeholder="Ej: JQ25-427" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="name" class="required">Nombre y Apellidos</label>
                        <input type="text" id="name" name="name" placeholder="Ej: Anderson PAJARES Prudencio" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="age" class="required">Edad</label>
                        <input type="text" id="age" name="age" placeholder="Ej: 31 años" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="ind" class="required">IND (Médico Clínico)</label>
                        <input type="text" id="ind" name="ind" placeholder="Ej: Dr. Salemir A. LINDO G." required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="sample" class="required">Muestra</label>
                    <input type="text" id="sample" name="sample" placeholder="Ej: Quiste en glúteo derecho" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="receptionDate" class="required">Fecha de Recepción</label>
                        <input type="date" id="receptionDate" name="receptionDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportDate" class="required">Fecha de Informe</label>
                        <input type="date" id="reportDate" name="reportDate" required>
                    </div>
                </div>
            </div>
            
            <!-- Exámenes -->
            <div class="form-section">
                <h2><i class="fas fa-microscope"></i> Exámenes</h2>
                
                <div class="form-group">
                    <label for="macroscopicExam">Examen Macroscópico</label>
                    <textarea id="macroscopicExam" name="macroscopicExam" placeholder="Describa el examen macroscópico..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="microscopicExam">Examen Microscópico</label>
                    <textarea id="microscopicExam" name="microscopicExam" placeholder="Describa el examen microscópico..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="diagnosis">Diagnóstico</label>
                    <textarea id="diagnosis" name="diagnosis" placeholder="Escriba el diagnóstico..."></textarea>
                </div>
            </div>
            
            <div class="button-container">
                <button type="button" id="previewBtn"><i class="fas fa-eye"></i> Previsualizar</button>
                <button type="button" id="generateBtn"><i class="fas fa-file-word"></i> Generar Word</button>
            </div>
        </form>

        <!-- Sección de previsualización -->
        <div id="previewSection" class="preview-section hidden">
            <div class="preview-header">
                <h2><i class="fas fa-file-alt"></i> Vista Previa del Informe</h2>
                <button type="button" id="closePreview"><i class="fas fa-times"></i> Cerrar</button>
            </div>
            <div id="previewContent" class="preview-content">
                <!-- Aquí se mostrará la previsualización -->
            </div>
        </div>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Generando documento, por favor espere...</p>
        </div>

        <div id="successMessage" class="success-message">
            <i class="fas fa-check-circle"></i> Documento generado exitosamente
        </div>
    </div>

    <!-- Incluir las librerías necesarias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.1/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.1/pizzip-utils.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.42.1/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('pathologyForm');
            const previewBtn = document.getElementById('previewBtn');
            const generateBtn = document.getElementById('generateBtn');
            const closePreviewBtn = document.getElementById('closePreview');
            const previewSection = document.getElementById('previewSection');
            const previewContent = document.getElementById('previewContent');
            const loading = document.getElementById('loading');
            const successMessage = document.getElementById('successMessage');

            // Función para formatear fechas de YYYY-MM-DD a DD/MM/AAAA
            function formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }

            // Función para validar campos obligatorios
            function validateForm() {
                const requiredFields = form.querySelectorAll('[required]');
                let isValid = true;
                
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        isValid = false;
                        field.classList.add('error');
                    } else {
                        field.classList.remove('error');
                    }
                });
                
                return isValid;
            }

            // Función para obtener los datos del formulario
            function getFormData() {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                // Formatear fechas
                data.fecha_recepcion = formatDate(data.receptionDate);
                data.fecha_informe = formatDate(data.reportDate);
                
                return {
                    nombre: data.name,
                    codigo: data.code,
                    edad: data.age,
                    ind: data.ind,
                    muestra: data.sample,
                    fecha_recepcion: data.fecha_recepcion,
                    fecha_informe: data.fecha_informe,
                    examen_macroscopico: data.macroscopicExam,
                    examen_microscopico: data.microscopicExam,
                    diagnostico: data.diagnosis
                };
            }

            // Función para generar la previsualización
            function generatePreview() {
                if (!validateForm()) {
                    alert('Por favor, complete todos los campos obligatorios marcados con *.');
                    return;
                }
                
                const data = getFormData();
                
                // Generar el contenido de la previsualización
                let previewHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h1>INFORME DE ANATOMÍA PATOLÓGICA</h1>
                    </div>
                    <p><strong>NOMBRE:</strong> ${data.nombre} . ${data.codigo}</p>
                    <p><strong>EDAD:</strong> ${data.edad}</p>
                    <p><strong>IND:</strong> ${data.ind}</p>
                    <p><strong>MUESTRA:</strong> ${data.muestra}</p>
                    <p><strong>FECHA RECEPCIÓN:</strong> ${data.fecha_recepcion} &nbsp;&nbsp;&nbsp; <strong>FECHA DE INFORME:</strong> ${data.fecha_informe}</p>
                    <br>
                `;
                
                if (data.examen_macroscopico) {
                    previewHTML += `
                        <h2>EXAMEN MACROSCÓPICO</h2>
                        <p>${data.examen_macroscopico}</p>
                        <br>
                    `;
                }
                
                if (data.examen_microscopico) {
                    previewHTML += `
                        <h2>EXAMEN MICROSCÓPICO</h2>
                        <p>${data.examen_microscopico}</p>
                        <br>
                    `;
                }
                
                if (data.diagnostico) {
                    previewHTML += `
                        <h2>DIAGNÓSTICO</h2>
                        <p>${data.diagnostico}</p>
                    `;
                }
                
                previewContent.innerHTML = previewHTML;
                previewSection.classList.remove('hidden');
                
                // Desplazar hacia la sección de previsualización
                previewSection.scrollIntoView({ behavior: 'smooth' });
            }

            // Función para generar el documento Word
            function generateWord() {
                if (!validateForm()) {
                    alert('Por favor, complete todos los campos obligatorios marcados con *.');
                    return;
                }
                
                const data = getFormData();
                
                // Mostrar loading
                loading.classList.remove('hidden');
                generateBtn.disabled = true;
                
                // Crear una plantilla básica en memoria si no se puede cargar una externa
                const templateContent = `
                    <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                    <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
                        <w:body>
                            <w:p><w:r><w:t>INFORME DE ANATOMÍA PATOLÓGICA</w:t></w:r></w:p>
                            <w:p><w:r><w:t>NOMBRE: {nombre} . {codigo}</w:t></w:r></w:p>
                            <w:p><w:r><w:t>EDAD: {edad}</w:t></w:r></w:p>
                            <w:p><w:r><w:t>IND: {ind}</w:t></w:r></w:p>
                            <w:p><w:r><w:t>MUESTRA: {muestra}</w:t></w:r></w:p>
                            <w:p><w:r><w:t>FECHA RECEPCIÓN: {fecha_recepcion}   FECHA DE INFORME: {fecha_informe}</w:t></w:r></w:p>
                            <w:p><w:r><w:t></w:t></w:r></w:p>
                            {#examen_macroscopico}
                            <w:p><w:r><w:t>EXAMEN MACROSCÓPICO</w:t></w:r></w:p>
                            <w:p><w:r><w:t>{examen_macroscopico}</w:t></w:r></w:p>
                            <w:p><w:r><w:t></w:t></w:r></w:p>
                            {/examen_macroscopico}
                            {#examen_microscopico}
                            <w:p><w:r><w:t>EXAMEN MICROSCÓPICO</w:t></w:r></w:p>
                            <w:p><w:r><w:t>{examen_microscopico}</w:t></w:r></w:p>
                            <w:p><w:r><w:t></w:t></w:r></w:p>
                            {/examen_microscopico}
                            {#diagnostico}
                            <w:p><w:r><w:t>DIAGNÓSTICO</w:t></w:r></w:p>
                            <w:p><w:r><w:t>{diagnostico}</w:t></w:r></w:p>
                            {/diagnostico}
                        </w:body>
                    </w:document>
                `;
                
                try {
                    // Crear un nuevo documento ZIP
                    const zip = new PizZip();
                    
                    // Añadir el contenido de la plantilla
                    zip.file("word/document.xml", templateContent);
                    
                    // Añadir archivos necesarios para un documento Word básico
                    zip.file("[Content_Types].xml", `
                        <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                        <Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
                            <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
                            <Default Extension="xml" ContentType="application/xml"/>
                            <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
                        </Types>
                    `);
                    
                    zip.file("_rels/.rels", `
                        <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                        <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
                            <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
                        </Relationships>
                    `);
                    
                    zip.file("word/_rels/document.xml.rels", `
                        <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
                        <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
                        </Relationships>
                    `);
                    
                    // Inicializar docxtemplater
                    const doc = new docxtemplater(zip, {
                        paragraphLoop: true,
                        linebreaks: true,
                    });
                    
                    // Renderizar el documento con los datos
                    doc.render(data);
                    
                    // Generar el documento como blob
                    const out = doc.getZip().generate({
                        type: "blob",
                        mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                    });
                    
                    // Descargar el documento
                    saveAs(out, `Informe_${data.codigo}.docx`);
                    
                    // Mostrar mensaje de éxito
                    successMessage.style.display = 'block';
                    setTimeout(() => {
                        successMessage.style.display = 'none';
                    }, 3000);
                    
                } catch (error) {
                    console.error('Error al generar el documento:', error);
                    alert('Error al generar el documento: ' + error.message);
                } finally {
                    loading.classList.add('hidden');
                    generateBtn.disabled = false;
                }
            }

            // Event Listeners
            previewBtn.addEventListener('click', generatePreview);
            generateBtn.addEventListener('click', generateWord);
            closePreviewBtn.addEventListener('click', function() {
                previewSection.classList.add('hidden');
            });
            
            // Establecer fechas por defecto (hoy y dentro de 7 días)
            const today = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7);
            
            document.getElementById('receptionDate').valueAsDate = today;
            document.getElementById('reportDate').valueAsDate = nextWeek;
            
            // Validar campos en tiempo real
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                field.addEventListener('input', function() {
                    if (this.value.trim()) {
                        this.classList.remove('error');
                    }
                });
            });
        });
    </script>
</body>
</html>
