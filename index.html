<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Informes de Anatomía Patológica</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.0/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        header p {
            opacity: 0.9;
        }
        
        .form-container {
            padding: 30px;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .form-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 22px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 14px 25px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-clear {
            background-color: #e74c3c;
        }
        
        .btn-clear:hover {
            background-color: #c0392b;
        }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        
        .col {
            flex: 1;
            padding: 0 10px;
            min-width: 250px;
        }
        
        .preview-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-top: 30px;
            display: none;
        }
        
        .preview-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .image-upload {
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .image-upload:hover {
            border-color: #3498db;
        }
        
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .image-preview-item {
            width: 150px;
            height: 100px;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-preview-item .remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-upload-text {
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }
            
            .col {
                width: 100%;
            }
            
            .btn {
                width: 100%;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Generador de Informes de Anatomía Patológica</h1>
            <p>Complete el formulario para generar un informe en formato Word</p>
        </header>
        
        <div class="form-container">
            <form id="informeForm">
                <div class="form-section">
                    <h2>Datos del Paciente</h2>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="nombre">Nombre del Paciente</label>
                                <input type="text" id="nombre" name="nombre" required>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="codigo">Código</label>
                                <input type="text" id="codigo" name="codigo" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="edad">Edad</label>
                                <input type="text" id="edad" name="edad" required>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="ind">IND</label>
                                <input type="text" id="ind" name="ind" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="muestra">Muestra</label>
                                <input type="text" id="muestra" name="muestra" required>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="fecha_recepcion">Fecha de Recepción</label>
                                <input type="date" id="fecha_recepcion" name="fecha_recepcion" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="fecha_informe">Fecha de Informe</label>
                        <input type="date" id="fecha_informe" name="fecha_informe" required>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>Examen Macroscópico</h2>
                    <div class="form-group">
                        <label for="examen_macroscopico">Descripción del Examen Macroscópico</label>
                        <textarea id="examen_macroscopico" name="examen_macroscopico" required></textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>Examen Microscópico</h2>
                    <div class="form-group">
                        <label for="examen_microscopico">Descripción del Examen Microscópico</label>
                        <textarea id="examen_microscopico" name="examen_microscopico" required></textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>Diagnóstico</h2>
                    <div class="form-group">
                        <label for="diagnostico">Diagnóstico</label>
                        <textarea id="diagnostico" name="diagnostico" required></textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <h2>Imágenes del Informe</h2>
                    <p class="image-upload-text">Puede agregar imágenes que se incluirán en el informe (opcional)</p>
                    
                    <div class="image-upload" id="imageUpload">
                        <p>Haga clic aquí o arrastre imágenes para agregarlas</p>
                        <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
                    </div>
                    
                    <div class="image-preview" id="imagePreview"></div>
                </div>
                
                <div class="button-group">
                    <button type="button" id="generarBtn" class="btn">Generar Informe en Word</button>
                    <button type="button" id="limpiarBtn" class="btn btn-clear">Limpiar Formulario</button>
                </div>
            </form>
            
            <div class="preview-section" id="previewSection">
                <h3>Vista Previa del Nombre del Archivo</h3>
                <p id="fileNamePreview"></p>
            </div>
        </div>
    </div>

    <script>
        // Variables para almacenar las imágenes
        let uploadedImages = [];
        
        // Configurar el área de carga de imágenes
        const imageUpload = document.getElementById('imageUpload');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        
        imageUpload.addEventListener('click', () => {
            imageInput.click();
        });
        
        imageUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageUpload.style.borderColor = '#3498db';
        });
        
        imageUpload.addEventListener('dragleave', () => {
            imageUpload.style.borderColor = '#ddd';
        });
        
        imageUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUpload.style.borderColor = '#ddd';
            
            const files = e.dataTransfer.files;
            handleImageFiles(files);
        });
        
        imageInput.addEventListener('change', (e) => {
            const files = e.target.files;
            handleImageFiles(files);
        });
        
        function handleImageFiles(files) {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        const imageData = {
                            name: file.name,
                            data: e.target.result
                        };
                        
                        uploadedImages.push(imageData);
                        updateImagePreview();
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
        }
        
        function updateImagePreview() {
            imagePreview.innerHTML = '';
            
            uploadedImages.forEach((image, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                
                const img = document.createElement('img');
                img.src = image.data;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove';
                removeBtn.innerHTML = '×';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    uploadedImages.splice(index, 1);
                    updateImagePreview();
                });
                
                previewItem.appendChild(img);
                previewItem.appendChild(removeBtn);
                imagePreview.appendChild(previewItem);
            });
        }
        
        // Función para generar el documento Word
        document.getElementById('generarBtn').addEventListener('click', async function() {
            try {
            // Obtener los valores del formulario
            const nombre = document.getElementById('nombre').value;
            const codigo = document.getElementById('codigo').value.trim();
            const edad = document.getElementById('edad').value;
            const ind = document.getElementById('ind').value;
            const muestra = document.getElementById('muestra').value;
            const fechaRecepcion = document.getElementById('fecha_recepcion').value;
            const fechaInforme = document.getElementById('fecha_informe').value;
            const examenMacroscopico = document.getElementById('examen_macroscopico').value;
            const examenMicroscopico = document.getElementById('examen_microscopico').value;
            const diagnostico = document.getElementById('diagnostico').value;
            
            // Validar que todos los campos estén completos
            if (!nombre || !codigo || !edad || !ind || !muestra || !fechaRecepcion || !fechaInforme || 
                !examenMacroscopico || !examenMicroscopico || !diagnostico) { // Corregido para usar las variables correctas
                alert('Por favor, complete todos los campos del formulario.');
                return;
            }
            
            // Formatear fechas (corregido para evitar problemas de zona horaria)
            const fechaRecepcionObj = new Date(fechaRecepcion + 'T00:00:00');
            const fechaInformeObj = new Date(fechaInforme + 'T00:00:00');
            const fechaRecepcionFormateada = fechaRecepcionObj.toLocaleDateString('es-ES');
            const fechaInformeFormateada = fechaInformeObj.toLocaleDateString('es-ES');

            const { Paragraph, TextRun, Document, Packer, ImageRun } = docx;
            const { Paragraph, TextRun, Document, Packer, ImageRun, AlignmentType, HeadingLevel, UnderlineType } = docx;

            const imageParagraphs = [];
            for (const image of uploadedImages) {
                // La librería necesita el buffer de la imagen, no el data URL completo
                const response = await fetch(image.data);
                const blob = await response.blob();
                const buffer = await blob.arrayBuffer();

                imageParagraphs.push(
                    new Paragraph({
                        children: [
                            new ImageRun({
                                data: buffer,
                                transformation: {
                                    width: 500, // Ancho en píxeles
                                    height: 350, // Alto en píxeles
                                },
                            }),
                        ],
                    })
                );
            }

            const doc = new Document({
                sections: [{
                    children: [
                        new Paragraph({ text: "INFORME DE ANATOMÍA PATOLÓGICA", heading: "Heading1", alignment: "center" }),
                        new Paragraph({ 
                            text: "INFORME DE ANATOMÍA PATOLÓGICA", 
                            heading: HeadingLevel.HEADING_1, 
                            alignment: AlignmentType.CENTER 
                        }),
                        new Paragraph({ text: "" }), // Espacio
                        new Paragraph({
                            children: [
                                new TextRun({ text: "NOMBRE: ", bold: true }),
                                new TextRun({ text: `${nombre} . ${codigo}`, bold: true }),
                            ],
                        }),
                        new Paragraph({
                            children: [ new TextRun({ text: "EDAD: ", bold: true }), new TextRun({ text: edad, bold: true }) ],
                        }),
                        new Paragraph({
                            children: [ new TextRun({ text: "IND: ", bold: true }), new TextRun({ text: ind, bold: true }) ],
                        }),
                        new Paragraph({
                            children: [ new TextRun({ text: "MUESTRA: ", bold: true }), new TextRun({ text: muestra, bold: true }) ],
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({ text: "FECHA RECEPCIÓN: ", bold: true }),
                                new TextRun({ text: `${fechaRecepcionFormateada}   `, bold: true }),
                                new TextRun({ text: "FECHA DE INFORME: ", bold: true }),
                                new TextRun({ text: fechaInformeFormateada, bold: true }),
                            ],
                        }),
                        new Paragraph({ text: "" }), // Espacio
                        new Paragraph({ text: "EXAMEN MACROSCÓPICO", bold: true, underline: true }),
                        new Paragraph({ text: "EXAMEN MACROSCÓPICO", bold: true, underline: { type: UnderlineType.SINGLE } }),
                        new Paragraph({ text: examenMacroscopico }),
                        new Paragraph({ text: "" }), // Espacio
                        new Paragraph({ text: "EXAMEN MICROSCÓPICO", bold: true, underline: true }),
                        new Paragraph({ text: "EXAMEN MICROSCÓPICO", bold: true, underline: { type: UnderlineType.SINGLE } }),
                        new Paragraph({ text: examenMicroscopico }),
                        new Paragraph({ text: "" }), // Espacio
                        new Paragraph({ text: "DIAGNÓSTICO", bold: true, underline: true }),
                        new Paragraph({ text: "DIAGNÓSTICO", bold: true, underline: { type: UnderlineType.SINGLE } }),
                        new Paragraph({ text: diagnostico }),
                        ...imageParagraphs // Añadir las imágenes al final
                    ],
                }],
            });

            // Generar el archivo .docx y descargarlo
            Packer.toBlob(doc).then(blob => {
                const fileName = `${codigo}${nombre.replace(/ /g, '_')}.docx`;
                saveAs(blob, fileName);
            });
            
            // Mostrar vista previa del nombre del archivo
            document.getElementById('fileNamePreview').textContent = `${codigo}${nombre}.docx`;
            document.getElementById('previewSection').style.display = 'block';
            } catch (error) {
                console.error("Error al generar el documento:", error);
                alert("Ocurrió un error inesperado al generar el documento. Por favor, revise la consola para más detalles.");
            }
        });
        
        // Función para limpiar el formulario
        document.getElementById('limpiarBtn').addEventListener('click', function() {
            document.getElementById('informeForm').reset();
            uploadedImages = [];
            updateImagePreview();
            document.getElementById('previewSection').style.display = 'none';
        });
        
        // Inicializar la fecha de recepción y fecha de informe con la fecha actual
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fecha_recepcion').value = today;
        document.getElementById('fecha_informe').value = today;
    </script>
</body>
</html>