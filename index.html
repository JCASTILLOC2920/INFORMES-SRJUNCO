<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Informes de Anatomía Patológica</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Generador de Informes de Anatomía Patológica</h1>
        
        <form id="pathologyForm">
            
            <!-- Datos del paciente -->
            <div class="form-section">
                <h2>Datos del Paciente</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="code" class="required">Código</label>
                        <input type="text" id="code" name="code" placeholder="Ej: JQ25-427" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="name" class="required">Nombre y Apellidos</label>
                        <input type="text" id="name" name="name" placeholder="Ej: Anderson PAJARES Prudencio" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="age" class="required">Edad</label>
                        <input type="text" id="age" name="age" placeholder="Ej: 31 años" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="ind" class="required">IND (Médico Clínico)</label>
                        <input type="text" id="ind" name="ind" placeholder="Ej: Dr. Salemir A. LINDO G." required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="sample" class="required">Muestra</label>
                    <input type="text" id="sample" name="sample" placeholder="Ej: Quiste en glúteo derecho" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="receptionDate" class="required">Fecha de Recepción</label>
                        <input type="date" id="receptionDate" name="receptionDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportDate" class="required">Fecha de Informe</label>
                        <input type="date" id="reportDate" name="reportDate" required>
                    </div>
                </div>
            </div>
            
            <!-- Exámenes -->
            <div class="form-section">
                <h2>Exámenes</h2>
                
                <div class="form-group">
                    <label for="macroscopicExam">Examen Macroscópico</label>
                    <textarea id="macroscopicExam" name="macroscopicExam" placeholder="Describa el examen macroscópico..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="microscopicExam">Examen Microscópico</label>
                    <textarea id="microscopicExam" name="microscopicExam" placeholder="Describa el examen microscópico..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="diagnosis">Diagnóstico</label>
                    <textarea id="diagnosis" name="diagnosis" placeholder="Escriba el diagnóstico..."></textarea>
                </div>
            </div>
            
            <div class="button-container">
                <button type="submit" id="generateBtn">Generar y Descargar Informe</button>
            </div>
        </form>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Generando documento, por favor espere...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('pathologyForm');
            const generateBtn = document.getElementById('generateBtn');
            const loading = document.getElementById('loading');

            // Manejar el envío del formulario
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                // Mostrar loading
                loading.classList.remove('hidden');
                generateBtn.disabled = true;
                
                try {
                    const response = await fetch('/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        // Descargar el archivo
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        
                        // Obtener el nombre del archivo del header o generarlo
                        const contentDisposition = response.headers.get('content-disposition');
                        let fileName = 'informe.docx';
                        if (contentDisposition) {
                            const fileNameMatch = contentDisposition.match(/filename="(.+)"/);
                            if (fileNameMatch) {
                                fileName = fileNameMatch[1];
                            }
                        }
                        
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } else {
                        const error = await response.json();
                        alert('Error: ' + error.error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error al generar el documento: ' + error.message);
                } finally {
                    loading.classList.add('hidden');
                    generateBtn.disabled = false;
                }
            });
            
            // Establecer fechas por defecto (hoy y dentro de 7 días)
            const today = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(today.getDate() + 7);
            
            document.getElementById('receptionDate').valueAsDate = today;
            document.getElementById('reportDate').valueAsDate = nextWeek;
        });
    </script>
</body>
</html>